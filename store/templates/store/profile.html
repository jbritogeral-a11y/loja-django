{% extends 'store/base.html' %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <h1 style="margin-bottom: 2rem;">Minha Conta</h1>

    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem; align-items: start;">
        
        <!-- Menu Lateral -->
        <div style="background: white; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;">
            <div style="padding: 1.5rem; background: var(--gray-light); border-bottom: 1px solid var(--border);">
                <div style="font-weight: 600;">{{ user.first_name|default:user.username }}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">{{ user.email }}</div>
            </div>
            <nav style="display: flex; flex-direction: column;">
                <a href="#encomendas" onclick="showTab('orders')" class="profile-link active">Minhas Encomendas</a>
                <a href="#dados" onclick="showTab('settings')" class="profile-link">Meus Dados</a>
                <form action="{% url 'store:logout' %}" method="post" style="border-top: 1px solid var(--border);">
                    {% csrf_token %}
                    <button type="submit" class="profile-link" style="width: 100%; text-align: left; background: none; border: none; cursor: pointer; color: red;">Sair</button>
                </form>
            </nav>
        </div>

        <!-- Conteúdo Principal -->
        <div>
            
            <!-- TAB: ENCOMENDAS -->
            <div id="tab-orders">
                <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Histórico de Encomendas</h2>
                {% if orders %}
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        {% for order in orders %}
                        <div style="border: 1px solid var(--border); padding: 1.5rem; border-radius: var(--radius); background: white;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;">
                                <div>
                                    <div style="font-weight: 700;">Encomenda #{{ order.id }}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">{{ order.created_at|date:"d F Y" }}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700;">{{ order.total_price }} €</div>
                                    <span style="
                                        display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-top: 4px;
                                        {% if order.status == 'completed' %}background: #d4edda; color: #155724;
                                        {% elif order.status == 'canceled' %}background: #f8d7da; color: #721c24;
                                        {% else %}background: #fff3cd; color: #856404;{% endif %}
                                    ">
                                        {{ order.get_status_display }}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem;">
                                {% for item in order.items.all %}
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span>{{ item.quantity }}x {{ item.product.name }}</span>
                                        <span>{{ item.price }} €</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: var(--radius); border: 1px solid var(--border);">
                        <p style="color: var(--text-muted);">Ainda não efetuou nenhuma encomenda.</p>
                        <a href="/" class="btn-primary" style="display: inline-block; width: auto;">Ir para a Loja</a>
                    </div>
                {% endif %}
            </div>

            <!-- TAB: DADOS -->
            <div id="tab-settings" style="display: none;">
                <div style="background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem;">
                    <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Os Meus Dados</h2>
                    <form method="post">
                        {% csrf_token %}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.3rem;">Primeiro Nome</label>
                                {{ user_form.first_name }}
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.3rem;">Último Nome</label>
                                {{ user_form.last_name }}
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.3rem;">Email</label>
                                {{ user_form.email }}
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: auto; margin-top: 1.5rem;">
                            Guardar Alterações
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .profile-link {
        display: block;
        padding: 1rem 1.5rem;
        color: var(--text-main);
        text-decoration: none;
        border-left: 3px solid transparent;
        transition: all 0.2s;
        font-size: 0.95rem;
    }
    .profile-link:hover { background: var(--gray-light); }
    .profile-link.active { border-left-color: var(--accent); background: #fff; font-weight: 600; }
    
    @media (max-width: 768px) {
        div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
    }
</style>

<script>
    function showTab(tabName) {
        // Esconder todos
        document.getElementById('tab-orders').style.display = 'none';
        document.getElementById('tab-settings').style.display = 'none';
        
        // Remover active dos links
        document.querySelectorAll('.profile-link').forEach(el => el.classList.remove('active'));
        
        // Mostrar o escolhido
        document.getElementById('tab-' + tabName).style.display = 'block';
        
        // Adicionar active ao link clicado (simplificado)
        event.target.classList.add('active');
    }
</script>
{% endblock %}